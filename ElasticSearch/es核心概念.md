### ES核心概念

ES是面向文档，关系行数据库和elasticsearch客观的对比![image-20201207144229939](upload\image-20201207144229939.png)

elasticsearch（集群）中可以包含多个索引（数据库），每个索引中可以包含多个类型（表），每个类型下又包含多个文档（行），每个文档中又包含多个字段（列）

### 物理设计

es在后台把每个索引分成多个分片，每分分片可以在集群中的不同服务器间迁移。

一个人就是一个集群，默认的集群名称就是elasticsearch

### 逻辑设计

一个索引类型中，包含多个文档，比如说文档1，文档2。当我们索引一篇文档时，可以通过这样的一个顺序找到他：索引->类型->文档ID。通过这个组合我们就能索引到某个具体的文档。注意ID不必是整数，实际上他是个字符串

### 文档

之前说es是面向文档的，那么就意味着索引和所搜索数据的最小单位是文档，es中，文档有几个重要属性

* 自我包含，一篇文档同时包含字段和对应的值，也就是同时包含key：value
* 可以是层次型的， 一个文档中包含自文档，复杂的逻辑就是这么来的
* 灵活的结构，文档不依赖预先定义的模式，我们知道关系型数据库中，要提前定义字段才能使用，在es中，对于字段是非常灵活的，有时候，我们可以忽略该字段，或者动态的添加一个新字段

尽管我们可以随意的新增或者忽略某个字段，但是，每个字段的类型非常重要，比如一个年龄字段类型，可以是字符串也可以是整型，因为es会保存字段和类型之间的映射及其他的设置。这种映射具体到每个映射的每种类型，这也是为什么在es中，类型有时候也称为映射类型。

###  类型

类型是文档的逻辑容器，就像关系型数据库一样，表格是行的容器。类型中对于字段的定义称为映射，比如name映射为字符串类型。我们说文档是无模式的，他们不需要拥有映射中所定义的所有字段，比如新增一个字段，那么es是怎么做的呢？es会自动的将新字段加入映射，但是这个字段的不确定他是什么类型，es就开始猜，如果这个值是18，那么es会认为他是整形。但是es也可能猜不对，所以最安全的方式就是提前定义好需要的映射，这点跟关系型数据库殊途同归了，先定义好字段，然后再使用，别整什么幺蛾子

### 索引

就是数据库

索引是映射类型的容器，es中的索引是一个非常强大的文档合集。索引存储了映射类型的字段和其他设置。探后他们被存储到了各个分片上。我们来研究下分片是如何工作的

#### 物理设计：节点和分片如何工作

一个集群至少有一个节点，而一个节点就是一个es进程，节点可以有多个索引默认的，如果你创建索引，那么索引将会有5个分片（primary shard， 又称主分片）构成的，每一个主分片会有一个副本（replica shard， 又称复制分片）

![image-20201207160623745](upload\image-20201207160623745.png)

上图是一个有3个节点的集群，可以看到主分片和对应的复制分片都不会在同一个节点内，这样有利于某个节点挂掉了，数据也不至于丢失。实际上，一个分片是一个lucene索引，一个包含==倒排索引==的文件目录，倒排索引的结构使得es在不扫描全部文档的情况下，就能告诉你哪些文档包含特定的关键字。

#### 倒排索引

es使用的是一种称为倒排索引的结构，采用lucene倒排索引作为底层。这种结构使用与快速的全文搜索，一个索引由文档中所有不重复的列表构成，对于每一个词，都有一个包含他的文档列表。例如：现在有两个文档，每个文档包含如下内容

```
good good study day#文档1包含的内容
hello good world day#文档2包含的内容
```

为了创建倒排索引，我们首先要将每个文档拆分成独立的词（或称为词条或者tokens），然后创建一个包含所有不重复的词条的排序列表，然后列出每个词条出现在哪个文档

| term  | doc_1 | doc_2 |
| :---: | :---: | :---: |
| good  |   √   |   √   |
| study |   √   |   ×   |
|  day  |   √   |   √   |
| hello |   ×   |   √   |
| world |   ×   |   √   |

现在我们试图搜索good study，只需要查看包含每个词条的文档 score

| term  | dac_1 | doc_2 |
| :---: | :---: | :---: |
| good  |   √   |   √   |
| study |   √   |   ×   |
| total |   2   |   1   |

两个文档都匹配，但是第一个文档比第二个匹配程度更高。如果没有别的条件，现在，这两个包含关键字的文档都将返回。

#### es索引和lucene索引的对比

在es中，索引这个词被频繁使用，这就是术语的使用。在es中，索引被分为多个片段，每份分片是一个lucene的索引。所以==一个es索引是由多个luence索引组成的==

elasticsearch-plugin可以通过这个命令来查看加载进来的插件

![image-20201207165808460](upload\image-20201207165808460.png)

